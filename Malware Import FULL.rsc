### Variables
:local url "https://api.qfeeds.com/api.php?feed_type=malware_ip&api_token=";
:local apitoken "XXXXXXXXXXXXXXXXXXXXXXXX";
# Set to "yes" to store entries in RAM only (prevents flash wear, recommended for frequent updates)
# Set to "no" to write entries to disk (persistent across reboots, but could cause flash wear on frequent updates)
:local useDynamic "yes";
###

# Disable DIFF schedule
/system scheduler disable [/system scheduler find where name="Malware Update - Diff"];

:log info ("Update Malware-list | start...");
:delay 600ms;

:set $url "$url$apitoken";


# Disable logging temporary to prevent garbage
/system logging/
set 0 disabled=yes;

:local hadOldList false;
:do {

  # Rename existing list for deletion
  /ip firewall address-list/
  :log info ("Renaming old list (if existing)");
  :local FWCount ([/ip firewall address-list print count-only where list="Malware-List"])
  :if ($FWCount > "0") do={
    :set hadOldList true;
    :foreach item in=[find where list="Malware-List"] do={
      set $item list="Malware-List - Old";
    }
  }

} on-error={
  :log error ("An error occurred while renaming the Old Address-lists");
}


  # Download Malware-list (paginated - stops automatically when no more data)
:local importSuccess false;
:local limit 10000;
:local page 1;
:local totalProcessed 0;
:do {
  :log info ("Downloading Malware-list (automatic pagination)...");
  :while ($page <= 999) do={
    :local fetchResult ([/tool fetch url="$url&page=$page&limit=$limit" mode=https output=user as-value]);
    :local status ($fetchResult -> "status");
    :local data ($fetchResult -> "data");
    
    :if ($status = "finished") do={
      :if ([:len $data] = 0) do={
        :log info ("No more data at page ".$page.", stopping");
        :set page 1000;
      } else={
        :local pageCount 0;
        :log info ("Processing page ".$page."...");
        
        # IMPORT retrieved data
        :while ([:len $data] != 0) do={
          :local newlinePos [:find $data "\n"];
          :local line "";
          :if ($newlinePos >= 0) do={
            :set line [:pick $data 0 $newlinePos];
            :set data [:pick $data ($newlinePos + 1) [:len $data]];
          } else={
            :set line $data;
            :set data "";
          }

          :if ([:len $line] > 0) do={
            :do {
              :if ($useDynamic = "yes") do={
                /ip firewall address-list add list="Malware-List" address=$line dynamic=yes;
              } else={
                /ip firewall address-list add list="Malware-List" address=$line;
              }
              :set importSuccess true;
              :set pageCount ($pageCount + 1);
              :set totalProcessed ($totalProcessed + 1);
            } on-error={}
          }
        }
        :log info ("Page ".$page." completed: ".$pageCount." IPs (Total: ".$totalProcessed.")");
        :set page ($page + 1);
        :delay 100ms;
      }
    } else={
      :log error ("Failed to fetch page ".$page." (status: ".$status."), stopping");
      :set page 1000;
    }
  }
  :log info ("Adding Address-list completed! Total processed: ".$totalProcessed." IPs");
  :delay 600ms;

} on-error={
  :log error ("Error occurred during import - will attempt rollback if needed");
}


# Check if import was successful and handle rollback if needed
:local newListCount ([/ip firewall address-list print count-only where list="Malware-List"]);
:if ($importSuccess && $newListCount > 0) do={
  # Import successful - remove old list
  :do {
    :log info ("Removing old Address-lists...");
    /ip firewall address-list remove [find list="Malware-List - Old"];
    :delay 600ms;
    :log info ("Removing old Address-lists completed!");
    :delay 600ms;
  } on-error={
    :log error ("Error removing old address list");
  }
} else={
  # Import failed - rollback to old list
  :if ($hadOldList) do={
    :log error ("Import failed or no entries imported - rolling back to previous list");
    :do {
      /ip firewall address-list/
      :foreach item in=[find where list="Malware-List - Old"] do={
        set $item list="Malware-List";
      }
      :log info ("Rollback completed - previous list restored");
    } on-error={
      :log error ("Rollback failed - manual intervention required!");
    }
  } else={
    :log warning ("Import failed but no previous list to rollback to");
  }
}


# Re-enable logging info
/system logging/
set 0 disabled=no;

# Enable Diff Schedule
/system scheduler enable [/system scheduler find where name="Malware Update - Diff"];


:delay 1s;
:log info ("Import script Malware-list | completed!");