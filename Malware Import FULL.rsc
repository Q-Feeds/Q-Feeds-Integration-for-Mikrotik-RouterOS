### Variables
:local url "https://api.qfeeds.com/api.php?feed_type=malware_ip&api_token=";
:local apitoken "XXXXXXXXXXXXXXXXXXXXXXXX";
# Set to "yes" to store entries in RAM only (prevents flash wear, recommended for frequent updates)
# Set to "no" to write entries to disk (persistent across reboots, but could cause flash wear on frequent updates)
:local useDynamic "yes";
:local files 0;
###

# Disable DIFF schedule
/system scheduler disable [/system scheduler find where name="Malware Update - Diff"];

:log info ("Update Malware-list | start...");
:delay 600ms;

:set $url "$url$apitoken";


# Disable logging temporary to prevent garbage
/system logging/
set 0 disabled=yes;

:local hadOldList false;
:do {

  # Rename existing list for deletion
  /ip firewall address-list/
  :log info ("Renaming old list (if existing)");
  :local FWCount ([/ip firewall address-list print count-only where list="Malware-List"])
  :if ($FWCount > "0") do={
    :set hadOldList true;
    :foreach item in=[find where list="Malware-List"] do={
      set $item list="Malware-List - Old";
    }
  }

} on-error={
  :log error ("An error occurred while renaming the Old Address-lists");
}


  # Download Malware-list
:local importSuccess false;
:do {
  :for file from=1 to=199 do={

    :local data ([/tool fetch url="$url&page=$file" mode=https output=user as-value] -> "data");
    :set files $file;
    :log info ("Part ".$file." downloaded");

    # IMPORT retrieved data
    :while ([:len $data] != 0) do={
      :local line [:pick $data 0 [:find $data "\n"]]


      :local isIPv4 ($line ~ "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(/[0-9]|[12][0-9]|3[0-2])?$");
      :local isIPv6 ($line ~ "^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}(/[0-9]|[1-9][0-9]|[1][0-1][0-9]|12[0-8])?$");
      :if ($isIPv4 || $isIPv6) do={

        :do {
          :if ($useDynamic = "yes") do={
            add list="Malware-List" address=$line dynamic=yes;
          } else={
            add list="Malware-List" address=$line;
          }
          :set importSuccess true;
        } on-error={}

      }

    :set data [:pick $data ([:find $data "\n"]+1) [:len $data]];
    }

  }

  :log info ("Adding Address-list completed!");
  :delay 600ms;

} on-error={
  :log error ("Error occurred during import - will attempt rollback if needed");
}


# Check if import was successful and handle rollback if needed
:local newListCount ([/ip firewall address-list print count-only where list="Malware-List"]);
:if ($importSuccess && $newListCount > 0) do={
  # Import successful - remove old list
  :do {
    :log info ("Removing old Address-lists...");
    /ip firewall address-list remove [find list="Malware-List - Old"];
    :delay 600ms;
    :log info ("Removing old Address-lists completed!");
    :delay 600ms;
  } on-error={
    :log error ("Error removing old address list");
  }
} else={
  # Import failed - rollback to old list
  :if ($hadOldList) do={
    :log error ("Import failed or no entries imported - rolling back to previous list");
    :do {
      /ip firewall address-list/
      :foreach item in=[find where list="Malware-List - Old"] do={
        set $item list="Malware-List";
      }
      :log info ("Rollback completed - previous list restored");
    } on-error={
      :log error ("Rollback failed - manual intervention required!");
    }
  } else={
    :log warning ("Import failed but no previous list to rollback to");
  }
}


# Re-enable logging info
/system logging/
set 0 disabled=no;

# Enable Diff Schedule
/system scheduler enable [/system scheduler find where name="Malware Update - Diff"];


:delay 1s;
:log info ("Import script Malware-list | completed!");

