### Variables
:local url "https://qfeeds.com/api.php?feed_type=malware_ip&api_token=";
:local apitoken "XXXXXXXXXXXXXXX";
:local files 0;
###

### Function to add IP addresses
:local ipUpdateList do= {
 :local line $msg;

:if ($line ~ "^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}") do={

         /ip firewall address-list
        :do {
          :if ($1 = "add") do= {
                 add list="Malware-List" address=($line.$cidr);
           :log info ("Blacklist == Added: ".$line);
         }
         :if ($1 = "remove") do= {
             remove [find address=($line.$cidr)];
           :log info ("Whitelist == Removed: ".$line);
         }
        } on-error={}

      }
}
###

:log info ("Update Q-Feeds list with new data | start...");
:delay 600ms;

:set $url "$url$apitoken";  


# disable logging temporary to prevent noise in the logs
/system logging/
set 0 disabled=yes;



  # Download malware difference list
:do {

    # IMPORT Data New Addresses (Blacklist)
    :local data ([/tool fetch url="$url&diff=yes" mode=https output=user as-value] -> "data");
    :log info ("Diff file downloaded.");
    :delay 600ms;

    :while ([:len $data] != 0) do={

      :if ([:find $data "+"] = 0) do= {
        :local line [:pick $data ([:find $data "+"]+1) [:find $data "\n"]];
        $ipUpdateList msg=($line) "add";
      }
     :if ([:find $data "-"] = 0) do= {
        :local line [:pick $data ([:find $data "-"]+1) [:find $data "\n"]];
        $ipUpdateList msg=($line) "remove";
      }


    :set data [:pick $data ([:find $data "\n"]+1) [:len $data]];
    }


} on-error={
  :log info ("Update script Q-Feeds (DIFF) | Completed with errors!");
}


# Enable logging
/system logging/
set 0 disabled=no;


:delay 1s;
:log info ("Update script Q-Feeds (DIFF) | Completed!");

