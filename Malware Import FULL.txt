### Variables
:local url "https://qfeeds.com/api.php?feed_type=malware_ip&api_token=";
:local apitoken "XXXXXXXXXXXXXXXXXXXXXXXX";
:local files 0;
###

# Disable DIFF schedule
/system scheduler disable [/system scheduler find where name="Malware Update - Diff"];

:log info ("Update Malware-list | start...");
:delay 600ms;

:set $url "$url$apitoken";


# Disable logging temporary to prevent garbage
/system logging/
set 0 disabled=yes;

:do {

  # Rename existing list for deletion
  /ip firewall address-list/
  :log info ("Renaming old list (if existing)");
  :local FWCount ([/ip firewall address-list print count-only where list="Malware-List"])
  :if ($FWCount > "0") do={
    :foreach item in=[find where list="Malware-List"] do={
      set $item list="Malware-List - Old";
    }
  }

} on-error={
  :log error ("An error occurred while renaming the Old Address-lists");
}


  # Download Malware-list
:do {
  :for file from=1 to=199 do={

    :local data ([/tool fetch url="$url&page=$file" mode=https output=user as-value] -> "data");
    :set files $file;
    :log info ("Part ".$file." downloaded");

    # IMPORT retrieved data
    :while ([:len $data] != 0) do={
      :local line [:pick $data 0 [:find $data "\n"]]


      :if ($line ~ "^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}") do={

        :do {
          add list="Malware-List" address=($line.$cidr);
        } on-error={}

      }

    :set data [:pick $data ([:find $data "\n"]+1) [:len $data]];
    }

  }

  :log info ("Adding Address-list completed!");
  :delay 600ms;

} on-error={}


:do {
  :log info ("Removing old Address-lists...");
  # Remove old list when new one is successfully imported
  /ip firewall address-list remove [find list="Malware-List - Old"];
  :delay 600ms;
  /ip firewall address-list remove [find list="Malware-White-List"];
  :log info ("Removing old Address-lists completed!");
  :delay 600ms;
} on-error={}


# Re-enable logging info
/system logging/
set 0 disabled=no;

# Enable Diff Schedule
/system scheduler enable [/system scheduler find where name="Malware Update - Diff"];


:delay 1s;
:log info ("Import script Malware-list | completed!");

