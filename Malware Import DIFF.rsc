### Variables
:local url "https://api.qfeeds.com/api.php?feed_type=malware_ip&api_token=";
:local apitoken "XXXXXXXXXXXXXXX";
# Set to "yes" to store entries in RAM only (prevents flash wear, recommended for frequent updates)
# Set to "no" to write entries to disk (persistent across reboots, but could cause flash wear on frequent updates)
:local useDynamic "yes";
###

### Function to add IP addresses
:local ipUpdateList do= {
 :local line $msg;

:if ([:len $line] > 0) do={
        :do {
          :if ($1 = "add") do= {
            :if ($useDynamic = "yes") do={
              /ip firewall address-list add list="Malware-List" address=$line dynamic=yes;
            } else={
              /ip firewall address-list add list="Malware-List" address=$line;
            }
           :log info ("Blacklist == Added: ".$line);
         }
         :if ($1 = "remove") do= {
             /ip firewall address-list remove [find address=$line list="Malware-List"];
           :log info ("Whitelist == Removed: ".$line);
         }
        } on-error={}
      }
}
###

:log info ("Update Q-Feeds list with new data | start...");
:delay 600ms;

:set $url "$url$apitoken";  


# disable logging temporary to prevent noise in the logs
/system logging/
set 0 disabled=yes;



  # Download malware difference list
:do {

    # IMPORT Data New Addresses (Blacklist)
    :local data ([/tool fetch url="$url&diff=yes" mode=https output=user as-value] -> "data");
    :log info ("Diff file downloaded.");
    :delay 600ms;

    :while ([:len $data] != 0) do={

      :if ([:find $data "+"] = 0) do= {
        :local line [:pick $data ([:find $data "+"]+1) [:find $data "\n"]];
        $ipUpdateList msg=($line) "add";
      }
     :if ([:find $data "-"] = 0) do= {
        :local line [:pick $data ([:find $data "-"]+1) [:find $data "\n"]];
        $ipUpdateList msg=($line) "remove";
      }


    :set data [:pick $data ([:find $data "\n"]+1) [:len $data]];
    }


} on-error={
  :log info ("Update script Q-Feeds (DIFF) | Completed with errors!");
}


# Enable logging
/system logging/
set 0 disabled=no;


:delay 1s;
:log info ("Update script Q-Feeds (DIFF) | Completed!");

